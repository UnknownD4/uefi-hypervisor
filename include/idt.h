#pragma once 
#include <stdint.h>
#include <efi.h>
#include <efilib.h>
#include "gdt.h"

#define    IDT_FLAG_GATE_TASK              0x5
#define    IDT_FLAG_GATE_16BIT_INT         0x6
#define    IDT_FLAG_GATE_16BIT_TRAP        0x7
#define    IDT_FLAG_GATE_32BIT_TRAP        0xF
#define     IDT_FLAG_GATE_64BIT_INT        0x8e
#define     IDT_FLAG_GATE_64BIT_TRAP        0x8f
#define    IDT_FLAG_RING0                  (0 << 5)
#define    IDT_FLAG_RING1                  (1 << 5)
#define   IDT_FLAG_RING2                  (2 << 5)
#define   IDT_FLAG_RING3                  (3 << 5)
#define    IDT_FLAG_PRESENT                0x80
//#define i686_GDT_CODE_SEGMENT (uint16_t)56
extern void i686_ISR0();
extern void i686_ISR1();
extern void i686_ISR2();
extern void i686_ISR3();
extern void i686_ISR4();
extern void i686_ISR5();
extern void i686_ISR6();
extern void i686_ISR7();
extern void i686_ISR8();
extern void i686_ISR9();
extern void i686_ISR10();
extern void i686_ISR11();
extern void i686_ISR12();
extern void i686_ISR13();
extern void i686_ISR14();
extern void i686_ISR15();
extern void i686_ISR16();
extern void i686_ISR17();
extern void i686_ISR18();
extern void i686_ISR19();
extern void i686_ISR20();
extern void i686_ISR21();
extern void i686_ISR22();
extern void i686_ISR23();
extern void i686_ISR24();
extern void i686_ISR25();
extern void i686_ISR26();
extern void i686_ISR27();
extern void i686_ISR28();
extern void i686_ISR29();
extern void i686_ISR30();
extern void i686_ISR31();
extern void i686_ISR32();
extern void i686_ISR33();
extern void i686_ISR34();
extern void i686_ISR35();
extern void i686_ISR36();
extern void i686_ISR37();
extern void i686_ISR38();
extern void i686_ISR39();
extern void i686_ISR40();
extern void i686_ISR41();
extern void i686_ISR42();
extern void i686_ISR43();
extern void i686_ISR44();
extern void i686_ISR45();
extern void i686_ISR46();
extern void i686_ISR47();
extern void i686_ISR48();
extern void i686_ISR49();
extern void i686_ISR50();
extern void i686_ISR51();
extern void i686_ISR52();
extern void i686_ISR53();
extern void i686_ISR54();
extern void i686_ISR55();
extern void i686_ISR56();
extern void i686_ISR57();
extern void i686_ISR58();
extern void i686_ISR59();
extern void i686_ISR60();
extern void i686_ISR61();
extern void i686_ISR62();
extern void i686_ISR63();
extern void i686_ISR64();
extern void i686_ISR65();
extern void i686_ISR66();
extern void i686_ISR67();
extern void i686_ISR68();
extern void i686_ISR69();
extern void i686_ISR70();
extern void i686_ISR71();
extern void i686_ISR72();
extern void i686_ISR73();
extern void i686_ISR74();
extern void i686_ISR75();
extern void i686_ISR76();
extern void i686_ISR77();
extern void i686_ISR78();
extern void i686_ISR79();
extern void i686_ISR80();
extern void i686_ISR81();
extern void i686_ISR82();
extern void i686_ISR83();
extern void i686_ISR84();
extern void i686_ISR85();
extern void i686_ISR86();
extern void i686_ISR87();
extern void i686_ISR88();
extern void i686_ISR89();
extern void i686_ISR90();
extern void i686_ISR91();
extern void i686_ISR92();
extern void i686_ISR93();
extern void i686_ISR94();
extern void i686_ISR95();
extern void i686_ISR96();
extern void i686_ISR97();
extern void i686_ISR98();
extern void i686_ISR99();
extern void i686_ISR100();
extern void i686_ISR101();
extern void i686_ISR102();
extern void i686_ISR103();
extern void i686_ISR104();
extern void i686_ISR105();
extern void i686_ISR106();
extern void i686_ISR107();
extern void i686_ISR108();
extern void i686_ISR109();
extern void i686_ISR110();
extern void i686_ISR111();
extern void i686_ISR112();
extern void i686_ISR113();
extern void i686_ISR114();
extern void i686_ISR115();
extern void i686_ISR116();
extern void i686_ISR117();
extern void i686_ISR118();
extern void i686_ISR119();
extern void i686_ISR120();
extern void i686_ISR121();
extern void i686_ISR122();
extern void i686_ISR123();
extern void i686_ISR124();
extern void i686_ISR125();
extern void i686_ISR126();
extern void i686_ISR127();
extern void i686_ISR128();
extern void i686_ISR129();
extern void i686_ISR130();
extern void i686_ISR131();
extern void i686_ISR132();
extern void i686_ISR133();
extern void i686_ISR134();
extern void i686_ISR135();
extern void i686_ISR136();
extern void i686_ISR137();
extern void i686_ISR138();
extern void i686_ISR139();
extern void i686_ISR140();
extern void i686_ISR141();
extern void i686_ISR142();
extern void i686_ISR143();
extern void i686_ISR144();
extern void i686_ISR145();
extern void i686_ISR146();
extern void i686_ISR147();
extern void i686_ISR148();
extern void i686_ISR149();
extern void i686_ISR150();
extern void i686_ISR151();
extern void i686_ISR152();
extern void i686_ISR153();
extern void i686_ISR154();
extern void i686_ISR155();
extern void i686_ISR156();
extern void i686_ISR157();
extern void i686_ISR158();
extern void i686_ISR159();
extern void i686_ISR160();
extern void i686_ISR161();
extern void i686_ISR162();
extern void i686_ISR163();
extern void i686_ISR164();
extern void i686_ISR165();
extern void i686_ISR166();
extern void i686_ISR167();
extern void i686_ISR168();
extern void i686_ISR169();
extern void i686_ISR170();
extern void i686_ISR171();
extern void i686_ISR172();
extern void i686_ISR173();
extern void i686_ISR174();
extern void i686_ISR175();
extern void i686_ISR176();
extern void i686_ISR177();
extern void i686_ISR178();
extern void i686_ISR179();
extern void i686_ISR180();
extern void i686_ISR181();
extern void i686_ISR182();
extern void i686_ISR183();
extern void i686_ISR184();
extern void i686_ISR185();
extern void i686_ISR186();
extern void i686_ISR187();
extern void i686_ISR188();
extern void i686_ISR189();
extern void i686_ISR190();
extern void i686_ISR191();
extern void i686_ISR192();
extern void i686_ISR193();
extern void i686_ISR194();
extern void i686_ISR195();
extern void i686_ISR196();
extern void i686_ISR197();
extern void i686_ISR198();
extern void i686_ISR199();
extern void i686_ISR200();
extern void i686_ISR201();
extern void i686_ISR202();
extern void i686_ISR203();
extern void i686_ISR204();
extern void i686_ISR205();
extern void i686_ISR206();
extern void i686_ISR207();
extern void i686_ISR208();
extern void i686_ISR209();
extern void i686_ISR210();
extern void i686_ISR211();
extern void i686_ISR212();
extern void i686_ISR213();
extern void i686_ISR214();
extern void i686_ISR215();
extern void i686_ISR216();
extern void i686_ISR217();
extern void i686_ISR218();
extern void i686_ISR219();
extern void i686_ISR220();
extern void i686_ISR221();
extern void i686_ISR222();
extern void i686_ISR223();
extern void i686_ISR224();
extern void i686_ISR225();
extern void i686_ISR226();
extern void i686_ISR227();
extern void i686_ISR228();
extern void i686_ISR229();
extern void i686_ISR230();
extern void i686_ISR231();
extern void i686_ISR232();
extern void i686_ISR233();
extern void i686_ISR234();
extern void i686_ISR235();
extern void i686_ISR236();
extern void i686_ISR237();
extern void i686_ISR238();
extern void i686_ISR239();
extern void i686_ISR240();
extern void i686_ISR241();
extern void i686_ISR242();
extern void i686_ISR243();
extern void i686_ISR244();
extern void i686_ISR245();
extern void i686_ISR246();
extern void i686_ISR247();
extern void i686_ISR248();
extern void i686_ISR249();
extern void i686_ISR250();
extern void i686_ISR251();
extern void i686_ISR252();
extern void i686_ISR253();
extern void i686_ISR254();
extern void i686_ISR255();

typedef struct _ISRSTATE{
    uint32_t ds;
    uint64_t r15, r14, r13, r12, r11, r10, r9, r8, rdi, rsi, rbp, rbx, rdx, rcx, rax;
    uint64_t interrupt, error;
    uint64_t rip, cs, eflag, rsp, ss;
} __attribute__((packed, aligned(1))) ISRSTATE, *PISRSTATE;

typedef union _IDTFlags {
    uint8_t All;
    struct {
        uint8_t gateType : 4;
        uint8_t zero : 1;
        uint8_t dpl : 2;
        uint8_t p : 1;
    } Fields;
} __attribute__((packed, aligned(1))) IDTFlags, *PIDTFlags;
typedef struct _IDTEntry {
    uint16_t offsetLow;
    uint16_t segmenetSelector;
    uint8_t ist;
    IDTFlags flags; 
    uint16_t offsetMiddle;
    uint32_t offsetHigh; 
    uint32_t reserved1;
} __attribute__((packed, aligned(1))) IDTEntry, *PIDTEntry;

typedef struct _IDTDescriptor {
    uint16_t limit;
    PIDTEntry isr;
} __attribute__((packed, aligned(1))) IDTDescriptor, *PIDTDescriptor;

typedef void (*ISRHandler) (ISRSTATE* regs);
extern ISRHandler g_ISRHandler[256];
extern IDTEntry __attribute__((aligned(16))) IDT_Gates[256];
extern IDTDescriptor g_IDT;

extern void initIDT();